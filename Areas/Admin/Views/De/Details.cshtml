@model WebBaiGiang_CKC.Models.De

@{
    ViewData["Title"] = "Details";
    Layout = "~/Areas/Admin/Views/Shared/_LayoutAdmin.cshtml";
    
    // Lấy danh sách lớp DISTINCT
    var distinctLops = Model.CauHoi_DeThi
        .Where(x => x.CauHoi?.ChuongNew?.LopHoc != null)
        .Select(x => x.CauHoi.ChuongNew.LopHoc)
        .GroupBy(x => x.MaLopHoc)
        .Select(g => g.First())
        .ToList();

    // Lấy danh sách chương DISTINCT
    var distinctChuong = Model.CauHoi_DeThi
        .Where(x => x.CauHoi?.ChuongNew != null)
        .Select(x => x.CauHoi.ChuongNew)
        .GroupBy(x => x.MaChuong)
        .Select(g => g.First())
        .ToList();
}

<ol class="breadcrumb">
    <li class="breadcrumb-item"><a asp-controller="Home" asp-action="Index">Trang chủ</a></li>
    <li class="breadcrumb-item"><a asp-controller="De" asp-action="Index">Quản lý đề</a></li>
    <li class="breadcrumb-item active">Xem chi tiết</li>

</ol>

<h1 class="text-center">XEM CHI TIẾT ĐỀ THI</h1>
<hr />

<!-- Thông tin đề -->
<div class="mb-4">
    <dl class="row">
        <dt class="col-sm-2">
            @Html.DisplayNameFor(model => model.KyKiemTra.TenKyKiemTra)
        </dt>
        <dd class="col-sm-10">
            @Html.DisplayFor(model => model.KyKiemTra.TenKyKiemTra)
        </dd>

        <dt class="col-sm-2">
            @Html.DisplayNameFor(model => model.SoCauHoi)
        </dt>
        <dd class="col-sm-10">
            @Html.DisplayFor(model => model.SoCauHoi)
        </dd>

        <dt class="col-sm-2">
            @Html.DisplayNameFor(model => model.DoKhoDe)
        </dt>
        <dd class="col-sm-10">
            @Html.DisplayFor(model => model.DoKhoDe)
        </dd>
    </dl>
</div>

<!-- Danh sách câu hỏi -->
<hr />
<h4>Danh sách câu hỏi</h4>

@if (Model.CauHoi_DeThi != null && Model.CauHoi_DeThi.Any())
{
    <table class="table table-centered w-100 dt-responsive nowrap" id="cauhoi-datatable">
        <thead class="table-dark text-center">
            <tr>
                <th style="display:none;">MaLop</th>
                <th style="display:none;">MaChuong</th>
                <th>#</th>
                <th>Nội dung câu hỏi</th>
                <th>Đáp án A</th>
                <th>Đáp án B</th>
                <th>Đáp án C</th>
                <th>Đáp án D</th>
                <th>Đáp án đúng</th>
                <th>Chương</th>
            </tr>
        </thead>

        <tbody class="text-center">
            @{
                int i = 1;
                foreach (var item in Model.CauHoi_DeThi)
                {
                    <tr>
                        <td style="display:none;">@item.CauHoi.ChuongNew?.MaLopHoc</td>
                        <td style="display:none;">@item.CauHoi.ChuongNew?.MaChuong</td>

                        <td>@i</td>
                        <td>@item.CauHoi.NoiDung</td>
                        <td>@item.CauHoi.DapAnA</td>
                        <td>@item.CauHoi.DapAnB</td>
                        <td>@item.CauHoi.DapAnC</td>
                        <td>@item.CauHoi.DapAnD</td>
                        <td>@item.CauHoi.DapAnDung</td>
                        <td>@item.CauHoi.ChuongNew?.TenChuong</td>
                    </tr>
                    i++;
                }
            }
        </tbody>
    </table>
}
else
{
    <p><em>Chưa có câu hỏi nào trong đề thi này.</em></p>
}

<!-- Nút điều hướng -->
<div class="mt-4">
    <a class="btn btn-primary" asp-action="Edit" asp-route-id="@Model.DeId">Sửa</a>
    <a class="btn btn-secondary" asp-action="Index">Quay lại</a>
</div>

<!-- Filter wrapper -->
<div id="filterWrapper" class="d-none">
    <div class="d-flex align-items-center filter-bar ms-3">
        <span class="badge bg-primary me-2">
            <i class="mdi mdi-filter-variant"></i> Bộ lọc
        </span>

        <!-- Lọc theo lớp -->
        <div class="me-2">
            <select id="lopFilter" class="form-select form-select-sm filter-select">
                <option value="">Lớp: Tất cả</option>
                @foreach (var lop in distinctLops)
                {
                    <option value="@lop.MaLopHoc">@lop.TenLopHoc</option>
                }
            </select>
        </div>

        <!-- Lọc theo chương -->
        <div>
            <select id="chuongFilter" class="form-select form-select-sm filter-select">
                <option value="">Chương: Tất cả</option>
                @foreach (var ch in distinctChuong)
                {
                    <option value="@ch.MaChuong" data-lop="@ch.MaLopHoc">@ch.TenChuong</option>
                }
            </select>
        </div>
    </div>
</div>


@section scripts{
      <!-- third party css -->
    <link href="~/AdminAssets/css/vendor/dataTables.bootstrap5.css" rel="stylesheet" type="text/css"> 
    <link href="~/AdminAssets/css/vendor/responsive.bootstrap5.css" rel="stylesheet" type="text/css">
    <!-- third party css end -->
    <!-- App css -->
    <link href="~/AdminAssets/css/icons.min.css" rel="stylesheet" type="text/css">
    <link href="~/AdminAssets/css/app.min.css" rel="stylesheet" type="text/css" id="light-style">
    <script src="~/AdminAssets/js/vendor/jquery.dataTables.min.js"></script>
    <script src="~/AdminAssets/js/vendor/dataTables.bootstrap5.js"></script>
    <script src="~/AdminAssets/js/vendor/dataTables.responsive.min.js"></script>
    <script src="~/AdminAssets/js/vendor/responsive.bootstrap5.min.js"></script>

<style>
    .filter-bar {
        background: #f8f9fa;
        padding: 6px 12px;
        border-radius: 6px;
        border: 1px solid #e1e1e1;
        display: flex;
        align-items: center;
        gap: .5rem;
        white-space: nowrap;
    }

    .filter-select {
        min-width: 160px;
    }

    #cauhoi-datatable_wrapper .dataTables_length {
        display: flex !important;
        align-items: center;
        gap: 1rem;
        white-space: nowrap;
        flex-wrap: nowrap !important;
        min-width: 450px; /* đủ chỗ cho cả filter đẹp */
    }

    .badge.bg-primary {
        font-size: 0.75rem;
        padding: 5px 8px;
    }

        #cauhoi-datatable_wrapper .dataTables_length {
        display: flex !important;
        align-items: center;
        justify-content: flex-start;
        gap: 1rem;
        white-space: nowrap !important;
        flex-wrap: nowrap !important;
        min-width: 420px; /* đủ rộng để filter không bị rớt */

    }

</style>

<script>
        $(function () {

            const dt = $('#cauhoi-datatable').DataTable({
                dom:
                    '<"row align-items-center mb-2"'
                        + '<"col-md-6"l>'
                        + '<"col-md-6 text-md-end"f>'
                    + '>'
                    + 'rt'
                    + '<"row align-items-center mt-2"'
                        + '<"col-md-6"i>'
                        + '<"col-md-6"p>'
                    + '>',
                responsive: true,
                autoWidth: false,
                pageLength: 10,
                columnDefs: [
                    { targets: [0,1], visible: false },
                    { targets: '_all', className: 'align-middle text-center' }
                ],
                language: {
                    paginate: {
                        previous: "<i class='mdi mdi-chevron-left'></i>",
                        next: "<i class='mdi mdi-chevron-right'></i>"
                    },
                    info: "Hiển thị _START_ đến _END_ trong _TOTAL_ câu hỏi",
                    lengthMenu:
                        "Hiển thị <select class='form-select form-select-sm ms-1 me-1'>"
                        + "<option value='5'>5</option>"
                        + "<option value='10'>10</option>"
                        + "<option value='20'>20</option>"
                        + "<option value='-1'>All</option>"
                        + "</select> câu hỏi"
                },
                drawCallback: function () {
                    $('#cauhoi-datatable_wrapper .dataTables_paginate .pagination')
                        .addClass('pagination-rounded');

                    $('#cauhoi-datatable_length label')
                        .addClass('form-label');
                },
                initComplete: function () {
                    const fw = $('#filterWrapper').removeClass('d-none');

                    // đứng ngay bên phải Hiển thị
                    const lengthArea = $('#cauhoi-datatable_wrapper .dataTables_length');
                    lengthArea.append(fw);

                    // --- FILTER LỚP ---
                    $('#lopFilter').on('change', function () {
                        let lopId = $(this).val();

                        // lọc table
                        dt.column(0).search(lopId ? '^' + lopId + '$' : '', true, false).draw();

                        // dropdown CHƯƠNG tự lọc theo lớp
                        $('#chuongFilter option').each(function () {
                            let lopOfChuong = $(this).data('lop');
                            if (!lopId || $(this).val() === "" || lopOfChuong == lopId)
                                $(this).show();
                            else
                                $(this).hide();
                        });

                        // reset chương khi đổi lớp
                        $('#chuongFilter').val('');
                        dt.column(1).search('', true, false).draw();
                    });


                    // --- FILTER CHƯƠNG ---
                    $('#chuongFilter').on('change', function () {
                        let val = $(this).val();
                        dt.column(1).search(val ? '^' + val + '$' : '', true, false).draw();
                    });

                }

            });

        });
    </script>
}
