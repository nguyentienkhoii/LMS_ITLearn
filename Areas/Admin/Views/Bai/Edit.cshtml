@model WebBaiGiang_CKC.Models.Bai
@{
    ViewData["Title"] = "Edit";
    Layout = "~/Areas/Admin/Views/Shared/_LayoutAdmin.cshtml";
    var lop = Model.Chuong?.LopHoc;
    var khoa = lop?.KhoaHoc;
    var gv = lop?.GiangVien;
}

<ol class="breadcrumb">
  <li class="breadcrumb-item"><a asp-controller="Home" asp-action="Index">Trang chủ</a></li>
  <li class="breadcrumb-item"><a asp-controller="Bai" asp-action="Index">Quản lý bài học</a></li>
  <li class="breadcrumb-item active">Sửa</li>
</ol>

<h1 class="text-center">SỬA BÀI HỌC</h1>
<hr />

<div class="card border-0 shadow-sm mb-3">
  <div class="card-header bg-light">
    <strong>Thông tin lớp & chương</strong>
  </div>
  <div class="card-body">
    <div class="row g-3 align-items-start">
      <div class="col-md-8">
        <dl class="row mb-0">
          <dt class="col-sm-4">Lớp học</dt>
          <dd class="col-sm-8">
            @if (lop != null) {
              @lop.TenLopHoc
              @if(!string.IsNullOrEmpty(lop.TenVietTat)) { <span class="text-muted">(@lop.TenVietTat)</span> }
            } else {
              <span class="text-muted">—</span>
            }
          </dd>

          <dt class="col-sm-4">Trạng thái</dt>
          <dd class="col-sm-8">@((lop?.TrangThai) ?? "—")</dd>

          <dt class="col-sm-4">Chương</dt>
          <dd class="col-sm-8">
            @Model.Chuong?.TenChuong <span class="text-muted">(Mã: @Model.MaChuong)</span>
          </dd>

          <dt class="col-sm-4">Khoá học</dt>
          <dd class="col-sm-8">@((khoa?.TenKhoaHoc) ?? "—")</dd>

          <dt class="col-sm-4">Giảng viên</dt>
          <dd class="col-sm-8">@((gv?.HoTen) ?? "—")</dd>
        </dl>
      </div>
      <div class="col-md-4 text-center">
        @if (!string.IsNullOrEmpty(lop?.AnhLopHoc)) {
          <img src="@lop.AnhLopHoc" class="img-fluid rounded border" alt="Ảnh lớp" />
        } else {
          <div class="border rounded p-4 text-muted">Không có ảnh lớp</div>
        }
      </div>
    </div>
  </div>
</div>

<div class="row">
  <form asp-action="Edit" method="post">
    @Html.AntiForgeryToken()
    <div asp-validation-summary="ModelOnly" class="text-danger"></div>

    <input type="hidden" asp-for="BaiId" />

    <!-- NEW: Chọn Lớp & Chương -->
    <div class="card border-0 shadow-sm mx-4 mb-3">
      <div class="card-header bg-light"><strong>Di chuyển bài sang lớp/chương khác (tuỳ chọn)</strong></div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Lớp</label>
            <select id="LopId" class="form-select" asp-items="ViewBag.LopList">
              <option value="">-- Chọn lớp học --</option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">Chương</label>
            <select id="ChuongId" asp-for="MaChuong" class="form-select" asp-items="ViewBag.ChuongId">
              <option value="">-- Chọn chương học --</option>
            </select>
            <span asp-validation-for="MaChuong" class="text-danger"></span>
          </div>
        </div>
      </div>
    </div>

    <div class="form-group flex-grow-1 mx-4">
      <label asp-for="TenBai" class="control-label"></label>
      <input asp-for="TenBai" class="form-control w-100" />
      <span asp-validation-for="TenBai" class="text-danger"></span>
    </div>

    <br />
    <div class="form-group flex-grow-1 mx-4">
      <label asp-for="SoBai" class="control-label"></label>
      <input asp-for="SoBai" class="form-control w-100" />
      <span asp-validation-for="SoBai" class="text-danger"></span>
    </div>

    <br />
    <div class="form-group flex-grow-1 mx-4">
      <label asp-for="MoTa" class="control-label"></label>
      <textarea asp-for="MoTa" class="form-control" id="htmlelementid"></textarea>
      <span asp-validation-for="MoTa" class="text-danger"></span>
    </div>

    <br />
    <div class="form-group flex-grow-1 mx-4 d-flex gap-2">
      <button type="submit" class="btn btn-primary">Lưu</button>
      <a class="btn btn-secondary" asp-action="Index">Quay lại</a>
    </div>
  </form>
</div>

@section scripts{
<script>
  $(function(){
    // Summernote giữ nguyên
    $('#htmlelementid').summernote({
      height: 700,
      toolbar: [
        ['style', ['style']],
        ['font', ['bold', 'underline', 'clear']],
        ['fontsize', ['fontsize']],
        ['fontname', ['fontname']],
        ['color', ['color']],
        ['para', ['ul', 'ol', 'paragraph']],
        ['table', ['table']],
        ['insert', ['link', 'picture', 'video']],
        ['view', ['fullscreen', 'codeview', 'help']],
      ],
    });

    // ===== Cascade Lớp -> Chương =====
    const $lop = $('#LopId');
    const $chuong = $('#ChuongId');

    function resetChuong() {
      $chuong.empty().append(new Option('-- Chọn chương học --',''));
    }

    $lop.on('change', function(){
      const lopId = $(this).val();
      resetChuong();

      if(!lopId){
        $chuong.prop('disabled', true);
        return;
      }
      $chuong.prop('disabled', true);

      $.getJSON('/Admin/Bai/GetChuongByLop', { lopId: lopId }, function(items){
        if(items && items.length){
          items.forEach(c => $chuong.append(new Option(c.text, c.id)));
        } else {
          $chuong.append(new Option('-- Không có chương --',''));
        }
        $chuong.prop('disabled', false);
      });
    });

    // Trạng thái ban đầu
    if(!$lop.val() && !$chuong.val()){
      $chuong.prop('disabled', true);
    }
  });
</script>
}
