
 @model IEnumerable<WebBaiGiang_CKC.Models.CauHoi> 
@* @using X.PagedList @using X.PagedList.Mvc.Core
@using X.PagedList.Web.Common 
@model IPagedList<WebBaiGiang_CKC.Models.CauHoi> *@

@{
    ViewData["Title"] = "Quản lý kho câu hỏi";
    Layout = "~/Areas/Admin/Views/Shared/_LayoutAdmin.cshtml";

      // Ép kiểu đơn giản cho ViewBag
    var lopList    = ViewBag.LopList    as IEnumerable<dynamic>;
    var chuongList = ViewBag.ChuongList as IEnumerable<dynamic>;
}

<ol class="breadcrumb">
    <li class="breadcrumb-item"><a asp-controller="Home" asp-action="Index">Trang chủ</a></li>
    <li class="breadcrumb-item active">Quản lý kho câu hỏi</li>
</ol>

<h1 class="text-center">QUẢN LÝ KHO CÂU HỎI</h1>
<hr />
<br />

<div class="d-flex justify-content-between">
    <a asp-action="Create" class="btn btn-success mb-2">Thêm câu hỏi</a>

    <div class="ml-auto">
        <button type="button" class="btn btn-info mb-2" data-bs-toggle="modal" data-bs-target="#staticBackdrop">
            Import File Excel
        </button>
        <a asp-action="DownloadExcel" class="btn btn-danger mb-2">Tải File Excel Mẫu</a>
    </div>
</div>

@await Html.PartialAsync("_PartialViewCreateList", new WebBaiGiang_CKC.Models.CauHoi())

 <!-- Template bộ lọc -->
<div id="khoCauHoiFiltersTemplate" class="d-none">
    <div class="filter-bar d-inline-flex align-items-center flex-nowrap">
        <span class="badge bg-primary me-2">
            <i class="mdi mdi-filter-variant"></i> Bộ lọc
        </span>

        <!-- Lọc theo lớp -->
        <div class="me-2">
            <select id="lopFilterKhoTemplate" class="form-select form-select-sm filter-select">
                <option value="">Lớp: Tất cả</option>
                @if (lopList != null)
                {
                    foreach (var l in lopList)
                    {
                        <option value="@l.MaLopHoc">@l.TenLopHoc</option>
                    }
                }
            </select>
        </div>

        <!-- Lọc theo chương -->
        <div>
            <select id="chuongFilterKhoTemplate" class="form-select form-select-sm filter-select">
                <option value="">Chương: Tất cả</option>
                @if (chuongList != null)
                {
                    foreach (var ch in chuongList)
                    {
                        <option value="@ch.MaChuong" data-lop="@ch.MaLopHoc">@ch.TenChuong</option>
                    }
                }
            </select>
        </div>
    </div>
</div>
<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-centered w-100 dt-responsive nowrap" id="khoCauHoi-datatable">
                <thead class="table-dark text-center">
                    <tr>
                        <th style="display:none;">MaLop</th>
                        <th style="display:none;">MaChuong</th>
                        <th>Lớp học</th>
                        <th>Chương</th>
                        <th>Nội dung câu hỏi</th>
                        <th>Đáp án A</th>
                        <th>Đáp án B</th>
                        <th>Đáp án C</th>
                        <th>Đáp án D</th>
                        <th>Độ khó (%)</th>
                        <th style="width:120px;">Hành động</th>
                    </tr>
                </thead>
                <tbody class="text-center">
                    @if (Model != null && Model.Any())
                    {
                        foreach (var item in Model)
                        {
                            <tr class="align-middle">
                                <td style="display:none;">@item.ChuongNew?.LopHoc?.MaLopHoc</td>
                                <td style="display:none;">@item.ChuongNew?.MaChuong</td>

                                <td>@item.ChuongNew?.LopHoc?.TenLopHoc</td>
                                <td>@item.ChuongNew?.TenChuong</td>
                                <td>@Html.Raw(item.NoiDung)</td>
                                <td>@item.DapAnA</td>
                                <td>@item.DapAnB</td>
                                <td>@item.DapAnC</td>
                                <td>@item.DapAnD</td>
                                <td>@item.DoKho</td>
                                <td class="table-action text-center">
                                    <a asp-action="Details" asp-route-id="@item.CauHoiId" class="action-icon" title="Xem chi tiết">
                                        <i class="mdi mdi-eye" style="color:#19b6ff;font-size:22px;"></i>
                                    </a>
                                    <a asp-action="Edit" asp-route-id="@item.CauHoiId" class="action-icon" title="Chỉnh sửa">
                                        <i class="mdi mdi-square-edit-outline" style="color:#ffd83b;font-size:22px;"></i>
                                    </a>
                                    <a asp-action="Delete" asp-route-id="@item.CauHoiId" class="action-icon" title="Xóa">
                                        <i class="mdi mdi-delete" style="color:#e75555;font-size:22px;"></i>
                                    </a>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="11" class="text-center text-muted">
                                Chưa có câu hỏi nào trong cơ sở dữ liệu.
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

@section scripts{
    <!-- DataTables CSS -->
    <link href="~/AdminAssets/css/vendor/dataTables.bootstrap5.css" rel="stylesheet" type="text/css">
    <link href="~/AdminAssets/css/vendor/responsive.bootstrap5.css" rel="stylesheet" type="text/css">

    <!-- App css -->
    <link href="~/AdminAssets/css/icons.min.css" rel="stylesheet" type="text/css">
    <link href="~/AdminAssets/css/app.min.css" rel="stylesheet" type="text/css" id="light-style">

    <!-- DataTables JS -->
    <script src="~/AdminAssets/js/vendor/jquery.dataTables.min.js"></script>
    <script src="~/AdminAssets/js/vendor/dataTables.bootstrap5.js"></script>
    <script src="~/AdminAssets/js/vendor/dataTables.responsive.min.js"></script>
    <script src="~/AdminAssets/js/vendor/responsive.bootstrap5.min.js"></script>

    <style>
        .filter-bar {
            background: #f8f9fa;
            padding: 6px 12px;
            border-radius: 6px;
            border: 1px solid #e1e1e1;
            display: flex;
            align-items: center;
            gap: .75rem;
            white-space: nowrap;
        }

        .filter-select {
            min-width: 150px;
        }

        .badge.bg-primary {
            font-size: 0.75rem;
            padding: 5px 8px;
        }

        #khoCauHoi-datatable_wrapper .dataTables_length {
            display: flex;
            align-items: center;
            gap: 1rem;
            white-space: nowrap;
            flex-wrap: nowrap;
        }
    </style>

    <script>
    $(function () {
               if (!$.fn.DataTable) {
            console.error('DataTables chưa sẵn sàng');
            return;
        }

        const dt = $('#khoCauHoi-datatable').DataTable({
            dom:
                '<"row align-items-center mb-2"'
                    + '<"col-md-6"l>'
                    + '<"col-md-6 text-md-end"f>'
                + '>'
                + 'rt'
                + '<"row align-items-center mt-2"'
                    + '<"col-md-6"i>'
                    + '<"col-md-6"p>'
                + '>',
            responsive: true,
            autoWidth: false,
            pageLength: 10,
           columnDefs: [
            // 0 = MaLop (ẩn), 1 = MaChuong (ẩn)
            { targets: [0, 1], visible: false },

            // 2 = Lớp học  → ưu tiên cao nhất
            { targets: 2, responsivePriority: 1, className: 'align-middle text-center' },

            // 3 = Chương   → ưu tiên 2
            { targets: 3, responsivePriority: 2, className: 'align-middle text-center' },

            // 4 = Nội dung → ưu tiên 3, căn trái cho dễ đọc
            { targets: 4, responsivePriority: 3, className: 'align-middle text-start' },

            // 10 = Hành động → ưu tiên 4, không sort
            { targets: 10, orderable: false, responsivePriority: 4, className: 'text-center' },

            // 5–9 = A,B,C,D,Độ khó → LUÔN vào child row
            { targets: [5, 6, 7, 8, 9], className: 'none align-middle text-center' }
        ],

            order: [[2, 'asc'], [3, 'asc']], // Lớp, Chương
            language: {
                paginate: {
                    previous: "<i class='mdi mdi-chevron-left'></i>",
                    next: "<i class='mdi mdi-chevron-right'></i>"
                },
                info: "Hiển thị _START_ đến _END_ trong _TOTAL_ câu hỏi",
                lengthMenu:
                    "Hiển thị <select class='form-select form-select-sm ms-1 me-1'>"
                    + "<option value='5'>5</option>"
                    + "<option value='10'>10</option>"
                    + "<option value='20'>20</option>"
                    + "<option value='-1'>All</option>"
                    + "</select> câu hỏi"
            },
            drawCallback: function () {
                $('#khoCauHoi-datatable_wrapper .dataTables_paginate .pagination')
                    .addClass('pagination-rounded');
                $('#khoCauHoi-datatable_length label').addClass('form-label');
            }
        });

        // === FILTER HOOK như cũ (không đổi) ===
        function khoFilter(settings, data, dataIndex) {
            if (settings.nTable.id !== 'khoCauHoi-datatable') return true;

            const pickedLop    = $('#lopFilterKho').val();
            const pickedChuong = $('#chuongFilterKho').val();

            if (pickedLop && String(data[0]) !== String(pickedLop)) return false;  // MaLop = cột 0 (ẩn)
            if (pickedChuong && String(data[1]) !== String(pickedChuong)) return false; // MaChuong = cột 1 (ẩn)

            return true;
        }

        if (!window.__khoFilterHook) {
            $.fn.dataTable.ext.search.push(khoFilter);
            window.__khoFilterHook = true;
        }

        // === CLONE UI filter như bạn đang dùng (giữ nguyên) ===
        const $template = $('#khoCauHoiFiltersTemplate .filter-bar');
        if ($template.length) {
            const $group = $template.clone();
            $('#khoCauHoi-datatable_wrapper .dataTables_length').append($group);

            const $lop    = $group.find('#lopFilterKhoTemplate').attr('id', 'lopFilterKho');
            const $chuong = $group.find('#chuongFilterKhoTemplate').attr('id', 'chuongFilterKho');

            function rebuildChuongOptions(maLop) {
                const $tpl = $('#khoCauHoiFiltersTemplate #chuongFilterKhoTemplate');
                const $cur = $('#chuongFilterKho');

                $cur.empty().append($('<option/>', { value: '', text: 'Chương: Tất cả' }));

                $tpl.find('option').each(function () {
                    const v = this.value;
                    if (!v) return;

                    const txt     = $(this).text();
                    const lopOfCh = $(this).data('lop');

                    if (!maLop || String(lopOfCh) === String(maLop)) {
                        $cur.append($('<option/>', { value: v, text: txt, 'data-lop': lopOfCh }));
                    }
                });
            }

            $lop.on('change', function () {
                rebuildChuongOptions(this.value);
                dt.draw();
            });

            $chuong.on('change', function () {
                dt.draw();
            });

            $('#lopFilterKho').val('');
            rebuildChuongOptions('');
            $('#chuongFilterKho').val('');
            dt.draw();
        }
    });
</script>

}  

@*
<table class="table table-striped table-bordered text-center align-middle">
    <thead class="table-dark">
        <tr>
            <th>Lớp học</th>
            <th>Chương</th>
            <th>Nội dung câu hỏi</th>
            <th>Đáp án A</th>
            <th>Đáp án B</th>
            <th>Đáp án C</th>
            <th>Đáp án D</th>
            <th>Độ khó (%)</th>
            <th>Hành động</th>
        </tr>
    </thead>
    <tbody>
        @if (Model != null && Model.Any())
        {
            foreach (var item in Model)
            {
                <tr>
                    <td>@item.ChuongNew?.LopHoc?.TenLopHoc</td>
                    <td>@item.ChuongNew?.TenChuong</td>
                    <td>@Html.Raw(item.NoiDung)</td>
                    <td>@item.DapAnA</td>
                    <td>@item.DapAnB</td>
                    <td>@item.DapAnC</td>
                    <td>@item.DapAnD</td>
                    <td>@item.DoKho</td>
                    <td>
                        <a asp-action="Details" asp-route-id="@item.CauHoiId" class="action-icon" title="Xem chi tiết">
                            <i class="mdi mdi-eye" style="color:#19b6ff;font-size:22px;"></i>
                        </a>
                        <a asp-action="Edit" asp-route-id="@item.CauHoiId" class="action-icon" title="Chỉnh sửa">
                            <i class="mdi mdi-square-edit-outline" style="color:#ffd83b;font-size:22px;"></i>
                        </a>
                        <a asp-action="Delete" asp-route-id="@item.CauHoiId" class="action-icon" title="Xóa">
                            <i class="mdi mdi-delete" style="color:#e75555;font-size:22px;"></i>
                        </a>
                    </td>
                </tr>
            }
        }
        else
        {
            <tr>
                <td colspan="8" class="text-center text-muted">Chưa có câu hỏi nào trong cơ sở dữ liệu.</td>
            </tr>
        }
    </tbody>
</table>

<!-- Pagination -->
<div class="d-flex justify-content-end mt-3">
    <ul class="pagination">
        @Html.PagedListPager(Model, page => Url.Action("Index", new { page }),
                 new PagedListRenderOptions
        {
            ActiveLiElementClass = "active",
            PageClasses = new[] { "page-link" },
            LiElementClasses = new[] { "page-item" },
            UlElementClasses = new[] { "pagination", "justify-content-center" },
            LinkToNextPageFormat = "Sau",
            LinkToPreviousPageFormat = "Trước",
            MaximumPageNumbersToDisplay = 3,
            DisplayLinkToPreviousPage = PagedListDisplayMode.Always,
            DisplayLinkToNextPage = PagedListDisplayMode.Always
        })
    </ul>
</div>  *@
