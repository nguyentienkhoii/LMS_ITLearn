@model IEnumerable<WebBaiGiang_CKC.Models.KyKiemTra>

@{
    var lstMon = ViewBag.lstSubject as List<LopHoc>;
    var hocVienIdClaim = User.Claims.FirstOrDefault(c => c.Type == "HocVienId");
    var hocVienId = hocVienIdClaim?.Value ?? "";
    var kiemtraviews = ViewBag.kiemtra as List<DanhSachThi>;
    var dk_can = ViewBag.DKCan;
}
@section Scripts {
    <script src="~/assets/js/menu_.js"></script>
}

<main>
    <div class="menu-toggle">
        <a href="#">Menu</a>
    </div>

    <div class="wrapper">
        @* @await Html.PartialAsync("~/Views/PartialView/_Menu0.cshtml") *@
        @await Html.PartialAsync("_SidebarMenu")

        <div class="noidung">
            <h2>Kỳ kiểm tra</h2>
            <hr />

            @{
                int count = 0;
            }

            @foreach (var item in kiemtraviews)
            {
                // Kiểm tra dữ liệu kỳ kiểm tra và học viên
                if (item?.HocVien == null || item.KyKiemTra == null)
                {
                    continue;
                }

                // Lấy bài làm của học viên nếu có
                var baiLam = item.KyKiemTra?.De?
                .SelectMany(d => d.CauHoi_DeThi)
                .SelectMany(cd => cd.CauHoi_BaiLam)
                .FirstOrDefault(cb => cb.BaiLam.MaHocVien.ToString() == hocVienId)
                ?.BaiLam;

                bool chuaLam = item.TrangThai == false
                && DateTime.UtcNow.AddHours(7) >= item.KyKiemTra.ThoiGianBatDau
                && DateTime.UtcNow.AddHours(7) < item.KyKiemTra.ThoiGianKetThuc;

                // Trạng thái: chưa có bài làm
                if (baiLam == null && chuaLam && item.HocVien.MaHocVien.ToString() == hocVienId)
                {
                    <div style="padding-bottom:20px;">
                        <div style="border: 2px solid #696969; border-radius: 10px; padding: 8px; overflow:hidden;">
                            <div style="float:left;padding-right:250px;">
                                <h2>@item.KyKiemTra.TenKyKiemTra</h2>
                                <p class="tieudethe">Bắt đầu: @item.KyKiemTra.ThoiGianBatDau</p>
                                <p class="tieudethe">Kết thúc: @item.KyKiemTra.ThoiGianKetThuc</p>
                                <p class="tieudethe">Thời gian làm bài: @item.KyKiemTra.ThoiGianLamBai phút</p>
                            </div>
                            <div style="float:left;padding-top:20px;padding-right:70px;">
                                <p>Trạng thái: Chưa làm</p>
                            </div>
                            <form asp-controller="BaiGiangs" asp-action="BaiKiemTra" method="post">
                                <div style="padding-top:20px;">
                                    <input type="hidden" name="id" value="@item.KyKiemTra.KyKiemTraId" />
                                    <button type="submit" class="btn btn-success mb-2">Bắt đầu làm bài</button>
                                </div>
                            </form>
                        </div>
                    </div>
                    count++;
                }
                // Trạng thái: đang làm, chưa hết thời gian
                else if (baiLam != null && chuaLam && baiLam.ThoiGianDenHan > DateTime.UtcNow.AddHours(7)
                && item.HocVien.MaHocVien.ToString() == hocVienId)
                {
                    <div style="padding-bottom:20px;">
                        <div style="border: 2px solid #696969; border-radius: 10px; padding: 8px; overflow:hidden;">
                            <div style="float:left;padding-right:250px;">
                                <h2>@item.KyKiemTra.TenKyKiemTra</h2>
                                <p class="tieudethe">Bắt đầu: @item.KyKiemTra.ThoiGianBatDau</p>
                                <p class="tieudethe">Kết thúc: @item.KyKiemTra.ThoiGianKetThuc</p>
                                <p class="tieudethe">Thời gian làm bài: @item.KyKiemTra.ThoiGianLamBai phút</p>
                            </div>
                            <div style="float:left;padding-top:20px;padding-right:70px;">
                                <p>Trạng thái: Chưa làm</p>
                            </div>
                            <form asp-controller="BaiGiangs" asp-action="BaiKiemTra" method="post">
                                <div style="padding-top:20px;">
                                    <input type="hidden" name="id" value="@item.KyKiemTra.KyKiemTraId" />
                                    <button type="submit" class="btn btn-success mb-2">Bắt đầu làm bài</button>
                                </div>
                            </form>
                        </div>
                    </div>
                    count++;
                }
            }

            @if (count == 0)
            {
                <div class="empty-state">
                    <img src="/contents/GioiThieu/12312312312.png" alt="empty">
                    <p style="text-align:center">Hiện tại không có kỳ kiểm tra nào.</p>
                    <p style="text-align:center">Bạn có thể học tập thêm trước kỳ thi tại trang chủ.</p>
                </div>
            }
        </div>
    </div>
</main>
